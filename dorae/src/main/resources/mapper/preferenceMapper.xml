<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="preference">

	<!-- 공연 취향 입력 -->
	<insert id="create" parameterType="preferenceVO">
		INSERT INTO preference (email, genre1, genre2, genre3, area1, area2, area3)
		VALUES (#{email}, #{genre1}, #{genre2}, #{genre3}, #{area1}, #{area2}, #{area3})
		ON DUPLICATE KEY UPDATE
		    genre1 = VALUES(genre1),
		    genre2 = VALUES(genre2),
		    genre3 = VALUES(genre3),
		    area1 = VALUES(area1),
		    area2 = VALUES(area2),
		    area3 = VALUES(area3)
	</insert>
	
	<!-- 본인의 취향설정 -->
	<select id="my" parameterType="String" resultType="preferenceVO">
		select * from preference where email = #{email}
	</select>

	<!-- 본인의 취향설정에 맞는 공연 추천 -->
	<select id="type" parameterType="String" resultType="playVO">
		SELECT p.play_id, p.stage_id, p.play_name, p.genre_name,
		    CASE
		        WHEN (s.address LIKE #{area1} AND p.genre_name = #{genre1}) THEN 3
		        WHEN (s.address LIKE #{area1} OR s.address LIKE #{area2} OR s.address LIKE #{area3}) THEN 2
		        WHEN p.genre_name IN (#{genre1}, #{genre2}, #{genre3}) THEN 1
		        ELSE 0
		    END AS score
		FROM play p
		JOIN stage s ON p.stage_id = s.stage_id
		WHERE (s.address LIKE #{area1} OR s.address LIKE #{area2} OR s.address LIKE #{area3})
		    AND (p.genre_name = #{genre1} OR p.genre_name = #{genre2} OR p.genre_name = #{genre3})
		    AND p.state = '공연중'
		ORDER BY score DESC;
	</select>
	
</mapper>